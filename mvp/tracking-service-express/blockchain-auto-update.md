# Автоматизация работы с Ethereum контрактом

В этом документе описаны изменения, внесенные для решения проблемы потери данных Ethereum ноды и автоматизации процесса развертывания контракта.

## Проблема

1. Ethereum нода запускается в контейнере Docker без постоянного хранилища
2. При перезапуске контейнера все данные блокчейна теряются
3. Требуется ручной деплой контракта после каждого перезапуска ноды
4. Адрес контракта нужно вручную обновлять в системе

## Решение

### 1. Постоянное хранилище для Ethereum ноды

Добавлен Docker volume для Ethereum ноды в `docker-compose.yml`:

```yaml
ethereum-node:
  image: trufflesuite/ganache-cli:latest
  # ...остальные настройки...
  command: >
    ganache-cli
    # ...остальные параметры...
    --db /data
  volumes:
    - ethereum_data:/data
```

Это позволяет сохранять состояние блокчейна между перезапусками контейнера.

### 2. Постоянное хранилище для файлов контракта

Адрес контракта теперь сохраняется в постоянном Docker volume:

```yaml
tracking-service:
  # ...остальные настройки...
  volumes:
    - contract_data:/usr/src/app/contracts
```

Это решает проблему потери файла с адресом контракта при перезапуске.

### 3. Автоматическая инициализация контракта

Создан скрипт `init-contract.sh`, который запускается при старте сервиса и:

1. Проверяет доступность Ethereum ноды
2. Проверяет наличие и валидность контракта по адресу из файла
3. Если контракт отсутствует или недействителен, автоматически выполняет деплой
4. Сохраняет новый адрес контракта в файл

### 3. Обновление Dockerfile

Модифицирован `Dockerfile` для tracking-service:

```dockerfile
# Создаем стартовый скрипт
RUN echo '#!/bin/sh\n\
# Инициализация контракта\n\
./scripts/init-contract.sh\n\
\n\
# Запуск сервера\n\
exec node server.js\n\
' > /usr/src/app/entrypoint.sh \
&& chmod +x /usr/src/app/entrypoint.sh

# Скрипт запуска
CMD ["/usr/src/app/entrypoint.sh"]
```

### 4. Скрипт проверки контракта

Добавлен скрипт `check-contract.js` для проверки статуса контракта:

```javascript
// Использование:
node scripts/check-contract.js
```

## Как это работает

1. При запуске контейнера tracking-service автоматически запускается `init-contract.sh`
2. Скрипт проверяет наличие и валидность контракта
3. Если контракт отсутствует, выполняется его деплой
4. Сервис запускается только после успешной инициализации контракта
