# Исправление ошибок при деплое смарт-контракта

Если вы столкнулись с ошибкой "cannot estimate gas; transaction may fail or may require manual gas limit" при деплое смарт-контракта, следуйте этим инструкциям для решения проблемы.

## Диагностика проблемы

Сначала проверьте подключение к Ethereum и состояние аккаунта:

```bash
cd /Users/dog/WebstormProjects/diplom/mvp/tracking-service-express
npm run check-ethereum
```

Этот скрипт проверит:

- Подключение к Ethereum ноде
- Баланс аккаунта
- Наличие достаточных средств для деплоя

## Распространенные причины ошибки и их решения

### 1. Недостаточный баланс аккаунта

**Признак:** В результате проверки вы видите сообщение о низком балансе.

**Решение для Ganache:**

```bash
# Запуск Ganache с высоким начальным балансом
docker run -d -p 8545:8545 trufflesuite/ganache-cli --account="0x[ВАШ_ПРИВАТНЫЙ_КЛЮЧ],100000000000000000000" -h 0.0.0.0
```

### 2. Несовместимость версии компилятора Solidity

**Признак:** Контракт компилируется, но не деплоится.

**Решение:**

```bash
# Перекомпилировать контракт с совместимой версией
npm install --no-save solc@0.8.17
npm run compile-contract
```

### 3. Проблемы с газом

**Признак:** Ошибка содержит "cannot estimate gas".

**Решение:** Установите вручную лимит газа. Скрипт deploy-contract.js уже обновлен для использования ручных настроек газа, но вы можете изменить параметры в скрипте:

```javascript
const deployOptions = {
  gasLimit: 5000000, // Увеличьте при необходимости
  gasPrice: ethers.utils.parseUnits("50", "gwei"), // Увеличьте при необходимости
};
```

## Повторный деплой контракта

После выполнения диагностики и необходимых исправлений запустите деплой снова:

```bash
npm run deploy-contract
```

## Полная переустановка блокчейн-окружения

Если проблемы сохраняются, попробуйте выполнить полную переустановку:

```bash
# Остановите все контейнеры Docker
docker-compose down

# Удалите старые файлы контракта
rm -f contracts/contract-address.txt

# Рестарт с чистой установкой
docker-compose up -d
```

## Проверка успешного деплоя

После успешного деплоя контракта, проверьте:

```bash
# Проверка наличия адреса контракта
cat contracts/contract-address.txt

# Запуск сервиса и проверка подключения
npm start
curl http://localhost:8080/ping
```

## Дополнительные ресурсы

- [Документация Ethers.js](https://docs.ethers.io/)
- [Документация Ganache](https://www.trufflesuite.com/docs/ganache/overview)
- [Руководство по отладке смарт-контрактов](https://ethereum.org/en/developers/tutorials/debugging-smart-contracts/)
